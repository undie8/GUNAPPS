<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Easy Spend</title>
    <script src="config.js"></script> 
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; overflow: hidden; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô scroll ‡∏ã‡πâ‡∏≠‡∏ô */ }
        
        /* Layout Scrollable Area */
        .scroll-container {
            height: calc(100vh - 140px); /* ‡∏´‡∏±‡∏Å Header ‡πÅ‡∏•‡∏∞ Bottom Bar */
            overflow-y: auto;
            padding-bottom: 80px; /* ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
        }
        .scroll-container::-webkit-scrollbar { width: 0px; background: transparent; }

        /* Numpad & Buttons */
        .numpad-btn { height: 55px; border-radius: 1rem; font-size: 1.4rem; font-weight: bold; background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(255,255,255,0.05); color: white; display: flex; align-items: center; justify-content: center; transition: 0.1s; cursor: pointer; }
        .numpad-btn:active { background: rgba(255,255,255,0.1); transform: scale(0.95); }
        
        .cat-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px; border-radius: 12px; background: rgba(30, 41, 59, 0.5); border: 1px solid transparent; transition: 0.2s; position: relative; cursor: pointer; }
        .cat-btn.selected { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; color: white; }

        /* Transaction List */
        .transaction-item { border-left: 4px solid; background: rgba(30, 41, 59, 0.4); }
        .border-exp { border-color: #ef4444; }
        .border-inc { border-color: #22c55e; }
        
        .cat-icon-circle { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.08); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-right: 12px; }

        /* Modal / Add Screen */
        #addModal { 
            position: fixed; inset: 0; background: #0f172a; z-index: 100; 
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }
        #addModal.open { transform: translateY(0); }

        /* Bottom Bar */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 10px 20px 25px 20px;
            display: flex; gap: 15px; z-index: 50;
        }
        .action-btn {
            flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;
            padding: 12px; border-radius: 1rem; font-weight: bold; cursor: pointer; transition: 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        .action-btn:active { transform: scale(0.97); }
    </style>
</head>
<body>

    <div class="fixed top-0 left-0 right-0 bg-slate-900/95 backdrop-blur-md z-50 border-b border-slate-800 h-16 flex items-center justify-between px-4">
        <button onclick="window.location.href='index'" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-800 text-slate-400 hover:text-white transition"><i class="fas fa-arrow-left"></i></button>
        <div class="text-center">
            <h1 class="text-sm text-slate-400 uppercase tracking-widest font-bold">Easy Spend</h1>
            <p id="currentMonthLabel" class="text-xs text-blue-400 font-bold">...</p>
        </div>
        <button onclick="openManage()" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-800 text-slate-400 hover:text-white transition"><i class="fas fa-cog"></i></button>
    </div>

    <div class="pt-20 px-4 max-w-md mx-auto scroll-container">
        
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-5 rounded-3xl border border-white/5 shadow-xl mb-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-24 h-24 bg-blue-500/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
            
            <div class="flex justify-between items-end mb-4">
                <div>
                    <p class="text-xs text-slate-400 uppercase font-bold mb-1">‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Balance)</p>
                    <h2 id="sumBalance" class="text-3xl font-bold text-white tracking-tight">0.00</h2>
                </div>
                <div class="w-12 h-12 rounded-2xl bg-slate-800 border border-white/10 flex items-center justify-center">
                    <i class="fas fa-wallet text-blue-400 text-xl"></i>
                </div>
            </div>
            
            <div class="flex gap-4">
                <div class="flex-1 bg-slate-800/50 p-2 rounded-xl border border-white/5">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-2 h-2 rounded-full bg-green-500"></div>
                        <p class="text-[10px] text-slate-400 uppercase">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</p>
                    </div>
                    <p id="sumInc" class="text-sm font-bold text-green-400 pl-4">0</p>
                </div>
                <div class="flex-1 bg-slate-800/50 p-2 rounded-xl border border-white/5">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-2 h-2 rounded-full bg-red-500"></div>
                        <p class="text-[10px] text-slate-400 uppercase">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</p>
                    </div>
                    <p id="sumExp" class="text-sm font-bold text-red-400 pl-4">0</p>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-end mb-2 px-1">
            <h3 class="text-sm font-bold text-slate-300">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
            <span class="text-[10px] text-slate-500">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô</span>
        </div>

        <div id="historyList" class="pb-10 space-y-3">
            <div class="text-center py-10"><i class="fas fa-circle-notch fa-spin text-blue-500"></i></div>
        </div>
    </div>

    <div class="bottom-bar max-w-md mx-auto">
        <div onclick="openAddModal('expense')" class="action-btn bg-red-500/10 text-red-400 border border-red-500/30 hover:bg-red-500 hover:text-white">
            <i class="fas fa-minus-circle"></i> ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
        </div>
        <div onclick="openAddModal('income')" class="action-btn bg-green-500/10 text-green-400 border border-green-500/30 hover:bg-green-500 hover:text-white">
            <i class="fas fa-plus-circle"></i> ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
        </div>
    </div>

    <div id="addModal">
        <div class="px-4 py-3 flex items-center justify-between border-b border-slate-800 bg-slate-900">
            <button onclick="closeAddModal()" class="text-slate-400 hover:text-white px-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <h2 id="modalTitle" class="text-white font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
            <button onclick="saveTransaction()" class="text-blue-400 font-bold px-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 max-w-md mx-auto w-full">
            
            <div class="bg-slate-800/50 p-4 rounded-2xl mb-4 text-right border border-white/5 cursor-pointer">
                <p class="text-xs text-slate-400 mb-1">‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</p>
                <div id="amountDisplay" class="text-4xl font-mono font-bold text-white tracking-widest overflow-hidden text-ellipsis whitespace-nowrap">0</div>
                <div id="calcPreview" class="text-sm text-slate-500 h-5 mt-1"></div>
            </div>

            <div id="catGrid" class="grid grid-cols-4 gap-2 mb-4"></div>

            <input type="text" id="noteInput" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥..." class="w-full bg-slate-800 p-3 rounded-xl text-white text-center mb-4 border border-slate-700 focus:border-blue-500 outline-none">

            <div class="grid grid-cols-4 gap-2 pb-10">
                <div class="numpad-btn" onclick="pressNum('7')">7</div><div class="numpad-btn" onclick="pressNum('8')">8</div><div class="numpad-btn" onclick="pressNum('9')">9</div><div class="numpad-btn bg-red-500/20 text-red-400 border-red-500/30" onclick="pressDel()"><i class="fas fa-backspace"></i></div>
                <div class="numpad-btn" onclick="pressNum('4')">4</div><div class="numpad-btn" onclick="pressNum('5')">5</div><div class="numpad-btn" onclick="pressNum('6')">6</div><div class="numpad-btn" style="background:rgba(59,130,246,0.15);color:#60a5fa" onclick="pressOp('/')">√∑</div>
                <div class="numpad-btn" onclick="pressNum('1')">1</div><div class="numpad-btn" onclick="pressNum('2')">2</div><div class="numpad-btn" onclick="pressNum('3')">3</div><div class="numpad-btn" style="background:rgba(59,130,246,0.15);color:#60a5fa" onclick="pressOp('*')">√ó</div>
                <div class="numpad-btn bg-slate-700 text-sm" onclick="pressClear()">C</div><div class="numpad-btn" onclick="pressNum('0')">0</div><div class="numpad-btn" onclick="pressNum('.')">.</div><div class="numpad-btn" style="background:rgba(59,130,246,0.15);color:#60a5fa" onclick="pressOp('-')">-</div>
                <div class="numpad-btn col-span-4 mt-2" style="background:rgba(59,130,246,0.15);color:#60a5fa" onclick="pressOp('+')">+</div>
            </div>
        </div>
    </div>

    <div id="loader" class="fixed inset-0 bg-slate-900/90 hidden flex-col items-center justify-center z-[150]">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-white mb-3"></div><p class="text-white text-xs">Syncing...</p>
    </div>

    <script>
        // --- CONFIG & STATE ---
        let currentType = 'expense';
        let currentInput = '0';
        let currentCat = null;
        let globalData = [];
        let globalCats = [];
        let editingRowIndex = null;

        const THAI_MONTHS = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
        const DEFAULT_CATS = [
            {type:'expense', icon:'üçî', name:'‡∏≠‡∏≤‡∏´‡∏≤‡∏£'},
            {type:'expense', icon:'üöó', name:'‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á'},
            {type:'income', icon:'üí∞', name:'‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'}
        ];

        window.onload = function() {
            // Set Header Month
            const now = new Date();
            document.getElementById('currentMonthLabel').innerText = `${THAI_MONTHS[now.getMonth()]} ${now.getFullYear()+543}`;
            
            fetchCategories();
            fetchData();
        };

        // --- DATA FETCHING ---
        async function fetchCategories() {
            try {
                const res = await fetch(`${CONFIG.SCRIPT_URL}?get=moneyCats`);
                const data = await res.json();
                globalCats = data.categories || [];
                if(globalCats.length === 0) globalCats = DEFAULT_CATS;
            } catch(e) { globalCats = DEFAULT_CATS; }
        }

        async function fetchData() {
            try {
                const res = await fetch(`${CONFIG.SCRIPT_URL}?get=moneyData&t=${Date.now()}`);
                const data = await res.json();
                globalData = data.items || [];
                renderSummaryCard();
                renderHistory();
            } catch(e) {}
        }

        // --- UI RENDERING ---
        function renderSummaryCard() {
            const now = new Date();
            const thisMonth = now.getMonth();
            const thisYear = now.getFullYear();
            
            let inc = 0, exp = 0;
            globalData.forEach(i => {
                const d = new Date(i.date);
                if(d.getMonth() === thisMonth && d.getFullYear() === thisYear) {
                    const amt = parseFloat(i.amount);
                    if(i.type === 'expense') exp += amt;
                    else inc += amt;
                }
            });

            document.getElementById('sumInc').innerText = '+' + inc.toLocaleString();
            document.getElementById('sumExp').innerText = '-' + exp.toLocaleString();
            document.getElementById('sumBalance').innerText = (inc - exp).toLocaleString(undefined, {minimumFractionDigits:2});
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            
            if(globalData.length === 0) { 
                list.innerHTML = '<div class="text-center py-10 opacity-50"><i class="fas fa-receipt text-4xl mb-2"></i><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>'; 
                return; 
            }

            // Calculate Daily Totals
            const dailyTotals = {};
            globalData.forEach(item => {
                const d = new Date(item.date);
                const dateStr = `${d.getDate()} / ${d.getMonth()+1} / ${d.getFullYear()+543}`;
                if (!dailyTotals[dateStr]) dailyTotals[dateStr] = 0;
                const amt = parseFloat(item.amount);
                if (item.type === 'expense') dailyTotals[dateStr] -= amt;
                else dailyTotals[dateStr] += amt;
            });

            let lastDate = '';
            globalData.forEach(item => {
                const d = new Date(item.date); 
                const dateStr = `${d.getDate()} / ${d.getMonth()+1} / ${d.getFullYear()+543}`;
                
                // Date Header
                if(dateStr !== lastDate) { 
                    const total = dailyTotals[dateStr];
                    const totalColor = total >= 0 ? 'text-green-400' : 'text-red-400';
                    const sign = total > 0 ? '+' : '';

                    list.innerHTML += `
                        <div class="flex justify-between items-end mt-6 mb-2 px-2 border-b border-slate-700/50 pb-1">
                            <span class="text-md font-bold text-slate-300 tracking-wide">${dateStr}</span>
                            <span class="text-xs font-bold ${totalColor} bg-slate-800 px-2 py-0.5 rounded-md border border-white/5">
                                ${sign}${total.toLocaleString()}
                            </span>
                        </div>`;
                    lastDate = dateStr; 
                }
                
                const isExp = item.type === 'expense';
                const icon = getCatIcon(item.category);
                
                list.innerHTML += `
                    <div class="transaction-item ${isExp?'border-exp':'border-inc'} p-3 rounded-xl mb-2 flex justify-between items-center shadow-sm" onclick="askEdit(${item.rowIndex})">
                        <div class="flex items-center">
                            <div class="cat-icon-circle">${icon}</div>
                            <div>
                                <div class="font-bold text-sm text-white">${item.category}</div>
                                <div class="text-xs text-slate-400">${item.note || ''}</div>
                            </div>
                        </div>
                        <div class="font-mono font-bold ${isExp?'text-red-400':'text-green-400'}">
                            ${isExp?'-':'+'}${parseFloat(item.amount).toLocaleString()}
                        </div>
                    </div>`;
            });
        }

        function getCatIcon(name) {
            const cat = globalCats.find(c => c.name === name);
            return cat ? cat.icon : 'üìù';
        }

        // --- MODAL ACTIONS ---
        function openAddModal(type) {
            editingRowIndex = null; // Clear edit mode
            currentType = type;
            document.getElementById('modalTitle').innerText = type === 'expense' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö';
            document.getElementById('noteInput').value = '';
            pressClear();
            renderCategories();
            document.getElementById('addModal').classList.add('open');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('open');
        }

        function renderCategories() {
            const grid = document.getElementById('catGrid'); grid.innerHTML = '';
            const filtered = globalCats.filter(c => c.type === currentType);
            
            filtered.forEach((c, idx) => {
                const isActive = (currentCat === c.name) ? 'selected' : '';
                if (idx === 0 && !currentCat) currentCat = c.name;
                grid.innerHTML += `<div class="cat-btn ${isActive}" onclick="selectCat('${c.name}', this)"><span class="text-2xl mb-1">${c.icon}</span><span class="text-[10px] text-slate-300 text-center leading-tight">${c.name}</span></div>`;
            });
            
            if(!document.querySelector('.cat-btn.selected') && filtered.length > 0) {
                 if(editingRowIndex) {
                    const found = [...grid.children].find(el => el.innerText.includes(currentCat));
                    if(found) { document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected')); found.classList.add('selected'); return; }
                }
                grid.firstElementChild.classList.add('selected'); currentCat = filtered[0].name; 
            }
        }
        
        function selectCat(name, el) { currentCat = name; document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); }

        // --- EDIT / DELETE / SAVE ---
        async function askEdit(rowIndex) {
            const item = globalData.find(i => i.rowIndex === rowIndex);
            if(!item) return;

            const res = await Swal.fire({
                title: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                text: `${item.category} ${item.amount}`,
                icon: 'info',
                showCancelButton: true,
                showDenyButton: true,
                confirmButtonText: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
                denyButtonText: '‡∏•‡∏ö',
                cancelButtonText: '‡∏õ‡∏¥‡∏î',
                confirmButtonColor: '#eab308',
                denyButtonColor: '#ef4444',
                background: '#1e293b', color: '#fff'
            });

            if (res.isConfirmed) {
                // Edit
                editingRowIndex = rowIndex;
                currentType = item.type;
                currentInput = String(item.amount);
                currentCat = item.category;
                document.getElementById('noteInput').value = item.note;
                document.getElementById('modalTitle').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
                renderCategories();
                updateDisplay();
                document.getElementById('addModal').classList.add('open');
            } else if (res.isDenied) {
                // Delete
                document.getElementById('loader').style.display = 'flex';
                await fetch(CONFIG.SCRIPT_URL, { method:'POST', body: JSON.stringify({action:'deleteEasySpend', rowIndex:rowIndex}) });
                fetchData();
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function saveTransaction() {
            const finalAmount = calculateResult();
            if(finalAmount <= 0) return Swal.fire({icon:'warning', title:'‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0', toast:true, position:'top'});
            
            document.getElementById('loader').style.display = 'flex';
            const actionType = editingRowIndex ? 'editEasySpend' : 'addEasySpend';
            const extraParams = editingRowIndex ? { rowIndex: editingRowIndex } : {};

            try {
                await fetch(CONFIG.SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: actionType, ...extraParams,
                        date: new Date().toISOString().split('T')[0],
                        type: currentType,
                        category: currentCat,
                        amount: finalAmount,
                        note: document.getElementById('noteInput').value
                    })
                });
                closeAddModal();
                fetchData();
            } catch(e) { Swal.fire('Error', e.message, 'error'); } 
            finally { document.getElementById('loader').style.display = 'none'; }
        }

        // --- MANAGE PAGE ---
        function openManage() {
            // Re-use the logic from previous turn, but maybe just show a simple Swal for now or toggle a view
            // For simplicity in this layout, let's keep it simple:
            Swal.fire({
                title: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà',
                text: '‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á UI ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠',
                icon: 'info',
                background: '#1e293b', color: '#fff'
            });
            // Or implement a separate manage.html if preferred
        }

        // --- CALCULATOR ---
        function pressNum(n) { if(currentInput==='0' && n!=='.') currentInput=n; else if(n==='.' && currentInput.slice(-1)==='.') return; else currentInput+=n; updateDisplay(); }
        function pressOp(op) { const last=currentInput.slice(-1); if(['+','-','*','/'].includes(last)) currentInput=currentInput.slice(0,-1)+op; else currentInput+=op; updateDisplay(); }
        function pressDel() { currentInput=currentInput.slice(0,-1); if(currentInput==='') currentInput='0'; updateDisplay(); }
        function pressClear() { currentInput='0'; document.getElementById('calcPreview').innerText=''; updateDisplay(); }
        function calculateResult() { try { if(/[^0-9+\-*/.]/.test(currentInput)) return 0; const r=new Function('return '+currentInput)(); return (!isFinite(r)||isNaN(r))?0:r; } catch(e){return 0;} }
        function updateDisplay() { let s=currentInput.replace(/\*/g,' √ó ').replace(/\//g,' √∑ ').replace(/\+/g,' + ').replace(/-/g,' - '); document.getElementById('amountDisplay').innerText=s; if(['+','-','*','/'].some(x=>currentInput.includes(x)) && !['+','-','*','/'].includes(currentInput.slice(-1))) { document.getElementById('calcPreview').innerText='= '+calculateResult().toLocaleString(undefined,{maximumFractionDigits:2}); } else { document.getElementById('calcPreview').innerText=''; } }

    </script>
</body>
</html>
