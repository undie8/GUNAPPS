<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GBase - Iron Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .input-dark { background: #1e293b; border: 1px solid #334155; color: white; border-radius: 8px; padding: 8px; width: 100%; outline: none; }
        .tab-btn.active { border-bottom: 2px solid #22c55e; color: #22c55e; background-color: rgba(30, 41, 59, 0.5); }
        .workout-card { background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 12px; }
        .workout-card.done { opacity: 0.5; border-color: #22c55e; }
        .photo-card { position: relative; border-radius: 12px; overflow: hidden; background: #1e293b; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .photo-card img { width: 100%; height: auto; display: block; }
        .photo-info { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding: 20px 12px 12px; color: white; }
    </style>
</head>
<body>
    <div id="loader" class="fixed inset-0 bg-slate-900/90 z-50 hidden flex-col items-center justify-center">
        <div class="w-8 h-8 border-4 border-green-500/20 border-t-green-500 rounded-full animate-spin mb-2"></div>
        <p class="text-green-400 text-xs">Processing...</p>
    </div>

    <div class="bg-slate-900 px-4 py-3 flex items-center justify-between border-b border-gray-800 sticky top-0 z-20">
        <a href="index.html" class="text-gray-400 font-bold text-xs uppercase">Back</a>
        <h1 class="text-lg font-bold text-green-500">IRON LOG</h1>
        <div class="w-8"></div>
    </div>

    <div class="p-4 max-w-lg mx-auto pb-20">
        <div class="flex bg-slate-800/50 rounded-lg p-1 mb-4">
            <button onclick="switchTab('workout')" id="tab-workout" class="tab-btn active flex-1 py-2 text-xs font-bold rounded-md">üèãÔ∏è ‡∏ó‡πà‡∏≤‡∏ù‡∏∂‡∏Å</button>
            <button onclick="switchTab('weight')" id="tab-weight" class="tab-btn flex-1 py-2 text-xs font-bold rounded-md">‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</button>
            <button onclick="switchTab('gallery')" id="tab-gallery" class="tab-btn flex-1 py-2 text-xs font-bold rounded-md">üì∏ ‡∏£‡∏π‡∏õ‡∏´‡∏∏‡πà‡∏ô</button>
        </div>

        <div id="view-workout">
            <input type="date" id="workoutDate" class="bg-transparent text-white font-bold text-lg mb-4 block mx-auto" onchange="renderWorkouts()">
            <div id="workoutList" class="space-y-2"></div>
            <button onclick="addWorkoutPrompt()" class="fixed bottom-6 right-6 bg-green-600 text-white w-14 h-14 rounded-full shadow-lg text-2xl font-bold flex items-center justify-center z-30">+</button>
        </div>

        <div id="view-weight" class="hidden">
            <h2 id="currentWeight" class="text-4xl font-bold text-center text-white my-4">--.-</h2>
            <div class="flex gap-2 mb-4">
                <input type="number" id="newWeight" placeholder="‡∏ô‡∏ô. ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" class="input-dark text-center">
                <button onclick="saveWeight()" class="bg-blue-600 text-white px-4 rounded-lg font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
            <div id="weightHistory" class="space-y-1"></div>
        </div>

        <div id="view-gallery" class="hidden">
            <div class="bg-slate-800/50 p-4 rounded-2xl border border-white/5 mb-4">
                <input type="date" id="photoDate" class="input-dark mb-2">
                <input type="file" id="photoInput" accept="image/*" class="text-sm text-gray-400 mb-3 block w-full">
                <button onclick="uploadPhoto()" class="w-full bg-green-600 text-white py-2 rounded-lg font-bold">‚¨ÜÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</button>
            </div>
            <div id="galleryList" class="space-y-4"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let globalData = {};

        window.onload = function() {
            document.getElementById('workoutDate').valueAsDate = new Date();
            document.getElementById('photoDate').valueAsDate = new Date();
            fetchData();
        }

        async function fetchData() {
            document.getElementById('loader').style.display = 'flex';
            try {
                const res = await fetch(`${CONFIG.SCRIPT_URL}?get=data&t=${new Date().getTime()}`);
                globalData = await res.json();
                renderWorkouts();
                renderWeight();
                renderGallery();
            } catch (e) { console.error(e); }
            document.getElementById('loader').style.display = 'none';
        }

        async function uploadPhoto() {
            const fileInput = document.getElementById('photoInput');
            if (fileInput.files.length === 0) return Swal.fire('Error', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', 'error');
            
            document.getElementById('loader').style.display = 'flex';
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = async function() {
                    const canvas = document.createElement('canvas');
                    const scale = 800 / img.width;
                    canvas.width = 800; canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    try {
                        const res = await fetch(CONFIG.SCRIPT_URL + '?t=' + new Date().getTime(), {
    method: 'POST',
    body: JSON.stringify({
        action: 'uploadPhoto',
        date: document.getElementById('photoDate').value,
        image: canvas.toDataURL('image/jpeg', 0.8)
    })
});
                        const result = await res.json();
                        if (result.status === 'error') throw new Error(result.message);
                        
                        fileInput.value = '';
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                        setTimeout(fetchData, 2000);
                    } catch (err) {
                        Swal.fire('Failed', err.message, 'error');
                    }
                    document.getElementById('loader').style.display = 'none';
                }
            }
        }

        // Functions for Display (Simplified for brevity)
        function renderWorkouts() { /* ...Logic ‡πÄ‡∏î‡∏¥‡∏°... */ 
             const date = document.getElementById('workoutDate').value;
             const list = document.getElementById('workoutList');
             list.innerHTML = '';
             (globalData.workouts || []).filter(w => w.date.startsWith(date)).forEach(w => {
                 list.innerHTML += `<div class="workout-card p-3 mb-2 flex justify-between text-white ${w.status==='Done'?'done':''} bg-slate-800"><div><b>${w.exercise}</b><br><span class="text-xs text-gray-400">${w.sets}</span></div></div>`;
             });
        }
        function renderWeight() { /* ...Logic ‡πÄ‡∏î‡∏¥‡∏°... */ 
            const list = document.getElementById('weightHistory');
            list.innerHTML = '';
            (globalData.weights || []).slice().reverse().forEach(w => {
                 list.innerHTML += `<div class="flex justify-between p-2 border-b border-gray-700 text-sm text-gray-300"><span>${w.date.split('T')[0]}</span><span>${w.weight} kg</span></div>`;
            });
            if(globalData.weights && globalData.weights.length > 0) 
                document.getElementById('currentWeight').innerText = globalData.weights[globalData.weights.length-1].weight;
        }
        function renderGallery() {
            const list = document.getElementById('galleryList');
            list.innerHTML = '';
            (globalData.gallery || []).slice().reverse().forEach(img => {
                list.innerHTML += `<div class="photo-card"><img src="${img.url}"><div class="photo-info"><b>${img.date.split('T')[0]}</b></div></div>`;
            });
        }
        
        // Functions for Actions
        async function saveWeight() {
            await sendPost({action:'addWeight', weight: document.getElementById('newWeight').value});
            fetchData();
        }
        async function addWorkoutPrompt() {
             const { value: formValues } = await Swal.fire({ title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡πà‡∏≤', html: '<input id="swal-ex" class="input-dark mb-2"><input id="swal-set" class="input-dark">', showCancelButton: true, preConfirm: () => [document.getElementById('swal-ex').value, document.getElementById('swal-set').value] });
             if(formValues) { await sendPost({action:'addWorkout', date: document.getElementById('workoutDate').value, exercise: formValues[0], sets: formValues[1]}); fetchData(); }
        }
        async function sendPost(data) {
            document.getElementById('loader').style.display = 'flex';
            await fetch(CONFIG.SCRIPT_URL, {method:'POST', body:JSON.stringify(data)});
            document.getElementById('loader').style.display = 'none';
        }
        function switchTab(t) {
            ['workout','weight','gallery'].forEach(x => {
                document.getElementById('view-'+x).classList.add('hidden');
                document.getElementById('tab-'+x).classList.remove('active');
            });
            document.getElementById('view-'+t).classList.remove('hidden');
            document.getElementById('tab-'+t).classList.add('active');
        }
    </script>
</body>
</html>
